name: Auto Bump Addon Version (Multi-Addon)

on:
  push:
    branches: [main]
    # Reagiert auf Dockerfile-Änderungen in jedem Unterordner
    paths:
      - '**/Dockerfile'

jobs:
  linting:
    uses: ./.github/workflows/lint.yaml

  bump-version:
    needs: linting
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 2  # Wichtig, um Änderungen zu vergleichen

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47.0.4
        with:
          files: "**/Dockerfile"

      - name: Update versions (config.yaml and run.sh)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            dir=$(dirname "$file")

            if [ -f "$dir/config.yaml" ]; then
              echo "Processing addon in $dir"

              # 1. Version aus config.yaml extrahieren
              OLD_VERSION=$(grep -oP 'version: "\K[^"]+' "$dir/config.yaml")

              # 2. Patch-Level erhöhen
              IFS='.' read -r major minor patch <<< "$OLD_VERSION"
              NEW_VERSION="$major.$minor.$((patch + 1))"

              # 3. Update config.yaml
              sed -i "s/version: \"$OLD_VERSION\"/version: \"$NEW_VERSION\"/g" "$dir/config.yaml"
              git add "$dir/config.yaml"

              # 4. Update run.sh (falls vorhanden)
              if [ -f "$dir/run.sh" ]; then
                echo "Updating version in $dir/run.sh to $NEW_VERSION"
                # Ersetzt die gesamte Zeile, die mit 'echo "App version:' beginnt
                sed -i "s/echo \"App version: .*\"/echo \"App version: $NEW_VERSION\"/g" "$dir/run.sh"
                git add "$dir/run.sh"
              fi
            fi
          done

          if ! git diff --cached --quiet; then
            git commit -m "chore: bump addon version to $NEW_VERSION [skip ci]"
            git push
          fi
